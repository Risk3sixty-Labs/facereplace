#!/usr/bin/env node

!function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t){e.exports=require("face-api.js")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("canvas")},function(e,t){e.exports=require("jimp")},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("request-promise-native")},function(e,t,r){r(8),r(9),e.exports=r(10)},function(e,t){e.exports=require("core-js/stable")},function(e,t){e.exports=require("regenerator-runtime/runtime")},function(e,t,r){"use strict";r.r(t);var a=r(2),n=r.n(a),i=r(1),o=r.n(i),c=(r(11),r(5));const s=r.n(c)()(process.argv.slice(2));!async function(){try{const e=s.f||s.face,t=s.p||s.pic;if(!e)throw new Error("enter the path or URL to a picture of a face to replace in your target picture");if(!t)throw new Error("enter the path or URL to a picture to replace faces in");const a=r(13).default,i=o.a.extname(t),c=o.a.join(process.env.HOME||process.env.USERPROFILE,`facereplace_${Date.now()}${i||"jpeg"}`),u=await a(e).replace(t);await n.a.promises.writeFile(c,u),console.log(`Successfully replaced faces and saved your file here: ${c}`.green)}catch(e){console.error("Error replacing faces",e)}finally{process.exit()}}()},function(e,t){e.exports=require("colors")},function(e,t){e.exports=require("@tensorflow/tfjs-node")},function(e,t,r){"use strict";r.r(t);var a=r(2),n=r.n(a),i=r(1),o=r.n(i),c=(r(12),r(3)),s=r(0);const{Canvas:u,Image:l,ImageData:f}=c;s.env.monkeyPatch({Canvas:u,Image:l,ImageData:f});var p={faceDetectionNet:s.nets.ssdMobilenetv1,loadedNet:!1,async init(){this.loadedNet||(await this.faceDetectionNet.loadFromDisk(o.a.join(__dirname,"..","..","weights")),this.loadedNet=!0)},async drawFaceOutlines(e){await this.init();const t=await c.loadImage(e),r=await s.detectAllFaces(t,this.getFaceDetectorOptions(this.faceDetectionNet)),a=s.createCanvasFromMedia(t);return s.draw.drawDetections(a,r),[r,a.toBuffer("image/jpeg")]},getFaceDetectorOptions:e=>e===s.nets.ssdMobilenetv1?new s.SsdMobilenetv1Options({minConfidence:.5}):new s.TinyFaceDetectorOptions({inputSize:408,scoreThreshold:.5})},h=r(6),d=r.n(h),m={getUrlBuffer:async e=>await d()({method:"GET",url:e,encoding:null}),async checkAndCreateDirectory(e){try{return await this.doesDirectoryExist(e)||await n.a.promises.mkdir(e),!0}catch(e){if("EEXIST"==e.code)return!0;throw e}},async doesDirectoryExist(e){try{return(await n.a.promises.stat(e)).isDirectory()}catch(e){return!1}}},w=r(4),y=r.n(w);function g(e=null){return{image:e,async open(e){return this.image=await y.a.read(e)},async toBuffer(e=this.image){return await e.getBufferAsync(y.a.MIME_JPEG)},cover(e,t=null){return this.image.cover(e,t||e)},composite(e,t,r){return this.image.composite(e,t,r)}}}function v(e){return{faceReplacePath:e,tmpPath:o.a.join(__dirname,"..","tmp"),setFacePicture(e){this.faceReplacePath=e},async replace(e){const t=g();await m.checkAndCreateDirectory(this.tmpPath),await this.confirmFacePathIsSet();let r=e;this.isStringValidUrl(r)&&(r=await this.getFileAndStoreLocally(r)),await t.open(r);const[a]=await p.drawFaceOutlines(r);return await Promise.all(a.map(async e=>{const r=g();await r.open(this.faceReplacePath),r.cover(parseInt(e._box._width),parseInt(e._box._height)),t.composite(r.image,parseInt(e._box._x),parseInt(e._box._y))})),await t.toBuffer()},async getFileAndStoreLocally(e){const t=e.split("/"),r=t[t.length-1],a=await m.getUrlBuffer(e),i=o.a.join(this.tmpPath,r);return await n.a.promises.writeFile(i,a),i},async confirmFacePathIsSet(){if(!this.faceReplacePath)throw new Error("Make sure a face replacement picture is set");return this.isStringValidUrl(this.faceReplacePath)?this.faceReplacePath=await this.getFileAndStoreLocally(this.faceReplacePath):this.faceReplacePath},isStringValidUrl:e=>/^https*\:\/\//.test(e)}}r.d(t,"default",(function(){return v}))}]);